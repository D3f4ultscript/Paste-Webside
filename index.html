<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Script Paste</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Segoe UI',monospace;background:linear-gradient(135deg,#0a0a0a 0%,#1a1a1a 100%);color:#fff;padding:40px 20px;min-height:100vh}
.container{max-width:900px;margin:0 auto}
h1{margin-bottom:22px;font-size:34px;background:linear-gradient(45deg,#0066ff,#00ccff);-webkit-background-clip:text;-webkit-text-fill-color:transparent;text-align:center}
.panel{background:rgba(42,42,42,0.6);padding:22px;border-radius:12px;margin-bottom:28px;backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,0.1);box-shadow:0 8px 32px rgba(0,0,0,0.4)}
input,textarea{width:100%;padding:14px;margin:10px 0;background:rgba(20,20,20,0.85);border:1px solid rgba(255,255,255,0.12);color:#fff;font-family:monospace;font-size:14px;border-radius:10px;transition:0.2s}
input:focus,textarea:focus{outline:none;border-color:#0066ff;box-shadow:0 0 15px rgba(0,102,255,0.25)}
textarea{min-height:200px;resize:vertical;font-size:13px;line-height:1.5}
.row{display:flex;gap:10px}
.btn{padding:12px 18px;background:linear-gradient(135deg,#0066ff,#0052cc);color:#fff;border:none;cursor:pointer;font-size:14px;border-radius:10px;font-weight:700;transition:0.2s;flex:1}
.btn:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(0,102,255,0.35)}
.btn:disabled{opacity:0.55;cursor:not-allowed;transform:none;box-shadow:none}
.btn.gray{background:linear-gradient(135deg,#333,#222)}
.list{margin-top:10px}
.item{background:rgba(42,42,42,0.55);padding:18px;margin:12px 0;border-left:4px solid #0066ff;border-radius:10px;backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,0.1);position:relative}
.item-header{display:flex;justify-content:space-between;align-items:center;gap:10px}
.item h3{font-size:17px;color:#00ccff;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:70%}
.small{font-size:12px;color:#9a9a9a;margin-top:6px}
.menu-btn{background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.08);color:#bbb;font-size:18px;cursor:pointer;padding:6px 10px;border-radius:8px}
.menu-btn:hover{color:#fff}
.dropdown{display:none;position:absolute;right:18px;top:52px;background:#222;border:1px solid #333;border-radius:10px;overflow:hidden;z-index:50;min-width:140px;box-shadow:0 10px 40px rgba(0,0,0,0.6)}
.dropdown.show{display:block}
.dropdown button{width:100%;text-align:left;background:none;border:none;color:#fff;padding:12px 14px;cursor:pointer;font-size:13px}
.dropdown button:hover{background:#0066ff}
.dropdown button.delete{color:#ff8080}
.dropdown button.delete:hover{background:#ff3333;color:#fff}
.links{display:flex;gap:14px;margin-top:10px}
.links a{font-size:13px;color:#4aa3ff;text-decoration:none;cursor:pointer}
.links a:hover{color:#7fd5ff}
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.88);z-index:1000;align-items:center;justify-content:center}
.modal.show{display:flex}
.modal-box{width:min(560px,92vw);background:#151515;border:1px solid #333;border-radius:12px;padding:22px;box-shadow:0 15px 60px rgba(0,0,0,0.75)}
.modal-box h2{font-size:18px;margin-bottom:12px;color:#00ccff}
.modal-actions{display:flex;gap:10px;margin-top:12px}
.modal-actions .btn{flex:1}
.loading{padding:18px;text-align:center;color:#7fd5ff}
</style>
</head>
<body>
<div class="container">
<h1>Script Paste</h1>

<div class="panel">
<input type="text" id="name" placeholder="Script Name">
<textarea id="code" placeholder="Paste your script here..."></textarea>
<input type="text" id="customId" placeholder="Custom ID (optional: banana)">
<div class="row">
<button class="btn" id="uploadBtn" onclick="upload()">Upload</button>
<button class="btn gray" onclick="clearForm()">Clear</button>
</div>
</div>

<div class="list" id="list"></div>
</div>

<div class="modal" id="pwModal">
<div class="modal-box">
<h2 id="pwTitle">Password</h2>
<input type="password" id="pwInput" placeholder="Enter password" autocomplete="off" onkeypress="if(event.key==='Enter')pwSubmit()">
<div class="modal-actions">
<button class="btn" onclick="pwSubmit()">OK</button>
<button class="btn gray" onclick="pwCancel()">Cancel</button>
</div>
</div>
</div>

<div class="modal" id="editModal">
<div class="modal-box">
<h2>Edit</h2>
<input type="text" id="editName" placeholder="Script Name">
<textarea id="editCode" placeholder="Script Code" style="min-height:280px"></textarea>
<div class="modal-actions">
<button class="btn" onclick="saveEdit()">Save</button>
<button class="btn gray" onclick="closeEdit()">Cancel</button>
</div>
</div>
</div>

<div class="modal" id="confirmModal">
<div class="modal-box">
<h2>Delete</h2>
<div style="color:#cfcfcf;margin-top:8px">Really delete this script?</div>
<div class="modal-actions">
<button class="btn gray" onclick="closeConfirm()">Cancel</button>
<button class="btn" style="background:linear-gradient(135deg,#ff3333,#c20000)" id="deleteBtn" onclick="confirmDelete()">Delete</button>
</div>
</div>
</div>

<script>
const PASS='Luna-132'

let sessionPw=''
let pwResolve=null
let pwReject=null

let editingId=null
let deleteId=null
let codeCache={}
let busy=false

function esc(s){
const d=document.createElement('div')
d.textContent=s==null?'':String(s)
return d.innerHTML
}

function closeAllDropdowns(){
document.querySelectorAll('.dropdown').forEach(d=>d.classList.remove('show'))
}

document.addEventListener('click',()=>closeAllDropdowns())

function openPw(title){
document.getElementById('pwTitle').textContent=title||'Password'
document.getElementById('pwInput').value=''
document.getElementById('pwModal').classList.add('show')
setTimeout(()=>document.getElementById('pwInput').focus(),50)
return new Promise((resolve,reject)=>{
pwResolve=resolve
pwReject=reject
})
}

function pwSubmit(){
const v=document.getElementById('pwInput').value
if(v!==PASS) return
document.getElementById('pwModal').classList.remove('show')
const r=pwResolve
pwResolve=pwReject=null
r(v)
}

function pwCancel(){
document.getElementById('pwModal').classList.remove('show')
const r=pwReject
pwResolve=pwReject=null
if(r) r(new Error('cancel'))
}

async function ensureSessionPassword(){
const pw=await openPw('Enter password to open this page')
sessionPw=pw
}

async function askActionPassword(title){
return await openPw(title||'Enter password')
}

async function apiFetch(path,opts,pw){
const o=opts||{}
o.headers=o.headers||{}
o.headers['X-Password']=pw
o.cache='no-store'
return await fetch(path,o)
}

function clearForm(){
document.getElementById('name').value=''
document.getElementById('code').value=''
document.getElementById('customId').value=''
}

function toggleMenu(id,event){
event.stopPropagation()
const dd=document.getElementById('menu-'+id)
document.querySelectorAll('.dropdown').forEach(x=>{ if(x!==dd) x.classList.remove('show') })
dd.classList.toggle('show')
}

async function fetchList(){
const res=await apiFetch('/api/list?t='+Date.now(),{method:'GET'},sessionPw)
if(res.status===401) throw new Error('unauthorized')
return await res.json()
}

async function loadList(){
try{
document.getElementById('list').innerHTML='<div class="loading">Loading...</div>'
const items=await fetchList()
if(!Array.isArray(items)||items.length===0){
document.getElementById('list').innerHTML='<div class="loading" style="color:#9a9a9a">No scripts</div>'
return
}
document.getElementById('list').innerHTML=items.map(s=>`
<div class="item">
<div class="item-header">
<h3>${esc(s.name)}</h3>
<button class="menu-btn" onclick="toggleMenu('${s.id}',event)">⋮</button>
<div class="dropdown" id="menu-${s.id}">
<button onclick="openEdit('${s.id}')">Edit</button>
<button class="delete" onclick="openDelete('${s.id}')">Delete</button>
</div>
</div>
<div class="small">${new Date(s.date||0).toLocaleString('de-DE')} • ID: ${esc(s.id)}</div>
<div class="links">
<a onclick="viewRaw('${s.id}',event)">View raw</a>
<a onclick="copyLoadstring('${s.id}',event)">Copy loadstring</a>
</div>
</div>
`).join('')
}catch(e){
document.getElementById('list').innerHTML='<div class="loading" style="color:#ff6666">Failed to load</div>'
}
}

async function waitForKV(id,shouldExist){
const max=15
for(let i=0;i<max;i++){
await new Promise(r=>setTimeout(r,1000))
try{
const items=await fetchList()
const ex=items.some(x=>x.id===id)
if(shouldExist && ex) return true
if(!shouldExist && !ex) return true
}catch(e){}
}
return false
}

async function upload(){
if(busy) return
const name=document.getElementById('name').value.trim()
const code=document.getElementById('code').value.trim()
const customId=document.getElementById('customId').value.trim()
if(!name||!code) return
try{
busy=true
document.getElementById('uploadBtn').disabled=true
const pw=await askActionPassword('Enter password to upload')
const res=await apiFetch('/api/upload',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name,code,customId})},pw)
const data=await res.json()
if(res.status!==200){busy=false;document.getElementById('uploadBtn').disabled=false;return}
clearForm()
await waitForKV(data.id,true)
await loadList()
}finally{
busy=false
document.getElementById('uploadBtn').disabled=false
}
}

async function openEdit(id){
closeAllDropdowns()
try{
const pw=await askActionPassword('Enter password to edit')
const res=await apiFetch('/api/get/'+id,{method:'GET'},pw)
const data=await res.json()
if(res.status!==200) return
editingId=id
document.getElementById('editName').value=''
document.getElementById('editCode').value=data.code||''
document.getElementById('editModal').classList.add('show')

const items=await fetchList()
const item=items.find(x=>x.id===id)
document.getElementById('editName').value=item?.name||'Unnamed'
} catch(e){}
}

function closeEdit(){
document.getElementById('editModal').classList.remove('show')
editingId=null
}

async function saveEdit(){
if(!editingId) return
const name=document.getElementById('editName').value.trim()
const code=document.getElementById('editCode').value.trim()
if(!name||!code) return
try{
const pw=await askActionPassword('Enter password to save edit')
const res=await apiFetch('/api/edit',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id:editingId,name,code})},pw)
if(res.status!==200) return
closeEdit()
await waitForKV(editingId,true)
await loadList()
} catch(e){}
}

function openDelete(id){
closeAllDropdowns()
deleteId=id
document.getElementById('confirmModal').classList.add('show')
}

function closeConfirm(){
document.getElementById('confirmModal').classList.remove('show')
deleteId=null
}

async function confirmDelete(){
if(!deleteId) return
try{
const pw=await askActionPassword('Enter password to delete')
const res=await apiFetch('/api/delete',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id:deleteId})},pw)
if(res.status!==200) return
const id=deleteId
closeConfirm()
await waitForKV(id,false)
await loadList()
} catch(e){}
}

function copyLoadstring(id,event){
event.preventDefault()
navigator.clipboard.writeText(`loadstring(game:HttpGet("${location.origin}/raw/${id}"))()`)
}

async function viewRaw(id,event){
event.preventDefault()
try{
const pw=await askActionPassword('Enter password to view raw')
const res=await apiFetch('/raw/'+id,{method:'GET'},pw)
if(res.status!==200) return
const t=await res.text()
const w=window.open('about:blank','_blank')
if(!w) return
w.document.open()
w.document.write('<pre style="white-space:pre-wrap;word-break:break-word;background:#0b0b0b;color:#fff;padding:16px;margin:0;font-family:monospace">'+
t.replace(/[&<>"]/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[m]))+
'</pre>')
w.document.close()
} catch(e){}
}

history.replaceState(null,'',location.pathname)

;(async()=>{
await ensureSessionPassword()
await loadList()
})()
</script>
</body>
</html>
