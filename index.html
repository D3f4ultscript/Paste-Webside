<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Script Paste</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Segoe UI',monospace;background:linear-gradient(135deg,#0a0a0a 0%,#1a1a1a 100%);color:#fff;padding:40px 20px;min-height:100vh}
.container{max-width:900px;margin:0 auto}
h1{margin-bottom:30px;font-size:36px;background:linear-gradient(45deg,#0066ff,#00ccff);-webkit-background-clip:text;-webkit-text-fill-color:transparent;text-align:center}
.session-bar{background:rgba(0,102,255,0.2);padding:10px 20px;border-radius:8px;margin-bottom:20px;text-align:center;font-size:13px;color:#00ccff;border:1px solid rgba(0,102,255,0.3)}
.upload-box{background:rgba(42,42,42,0.6);padding:25px;border-radius:12px;margin-bottom:40px;backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,0.1);box-shadow:0 8px 32px rgba(0,0,0,0.4)}
input,textarea{width:100%;padding:14px;margin:12px 0;background:rgba(20,20,20,0.8);border:1px solid rgba(255,255,255,0.1);color:#fff;font-family:monospace;font-size:14px;border-radius:8px;transition:0.3s}
input:focus,textarea:focus{outline:none;border-color:#0066ff;box-shadow:0 0 15px rgba(0,102,255,0.3)}
textarea{min-height:200px;resize:vertical;font-size:13px;line-height:1.5}
.btn-group{display:flex;gap:10px}
button{padding:12px 24px;background:linear-gradient(135deg,#0066ff,#0052cc);color:#fff;border:none;cursor:pointer;font-size:14px;border-radius:8px;font-weight:600;transition:0.3s;flex:1}
button:hover{transform:translateY(-2px);box-shadow:0 5px 20px rgba(0,102,255,0.4)}
button:disabled{opacity:0.5;cursor:not-allowed;transform:none}
button.clear{background:linear-gradient(135deg,#333,#222)}
button.clear:hover{box-shadow:0 5px 20px rgba(50,50,50,0.4)}
.list{margin-top:20px}
.item{background:rgba(42,42,42,0.6);padding:20px;margin:15px 0;border-left:4px solid #0066ff;border-radius:8px;backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,0.1);position:relative;transition:0.3s}
.item:hover{transform:translateX(5px);box-shadow:0 5px 25px rgba(0,102,255,0.2)}
.item h3{font-size:18px;margin-bottom:10px;color:#00ccff}
.item-header{display:flex;justify-content:space-between;align-items:center}
.menu-btn{background:none;border:none;color:#888;font-size:24px;cursor:pointer;padding:5px 10px;width:auto;flex:none;position:relative;transition:0.2s}
.menu-btn:hover{color:#fff;transform:none;background:rgba(255,255,255,0.1);border-radius:4px}
.dropdown{display:none;position:absolute;right:10px;top:40px;background:#2a2a2a;border:1px solid #444;border-radius:8px;overflow:hidden;z-index:100;min-width:140px;box-shadow:0 8px 30px rgba(0,0,0,0.7)}
.dropdown.show{display:block}
.dropdown button{background:none;border:none;color:#fff;padding:14px 20px;width:100%;text-align:left;font-size:14px;border-radius:0;flex:none;transition:0.2s;display:flex;align-items:center;gap:10px}
.dropdown button:hover{background:#0066ff;transform:none;box-shadow:none}
.dropdown button.delete{color:#ff6666}
.dropdown button.delete:hover{background:#ff3333;color:#fff}
.date{font-size:12px;color:#888;margin:8px 0}
.links{display:flex;gap:15px;margin-top:12px}
.links a{font-size:13px;color:#0066ff;text-decoration:none;transition:0.2s;cursor:pointer}
.links a:hover{color:#00ccff;text-shadow:0 0 10px rgba(0,204,255,0.5)}
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.85);z-index:1000;align-items:center;justify-content:center}
.modal.show{display:flex}
.modal-content{background:#1a1a1a;padding:30px;border-radius:12px;max-width:600px;width:90%;border:1px solid #333;box-shadow:0 10px 50px rgba(0,0,0,0.8)}
.modal h2{margin-bottom:20px;color:#00ccff}
.modal-buttons{display:flex;gap:10px;margin-top:20px}
.confirm-modal .modal-content{max-width:400px;text-align:center}
.confirm-modal p{margin:20px 0;font-size:16px;color:#ccc}
.hint{font-size:12px;color:#888;margin:-8px 0 12px 0}
.loading{text-align:center;padding:20px;color:#0066ff;font-size:14px}
@keyframes spin{to{transform:rotate(360deg)}}
.spinner{display:inline-block;width:16px;height:16px;border:2px solid #333;border-top-color:#0066ff;border-radius:50%;animation:spin 0.6s linear infinite;margin-right:8px}
</style>
</head>
<body>
<div class="container">
<div class="session-bar">
üîí Authenticated ‚Ä¢ Session expires in <span id="timer">3:00</span>
</div>
<h1>‚ú® Script Paste</h1>
<div class="upload-box">
<input type="text" id="name" placeholder="Script Name">
<textarea id="code" placeholder="Paste your script here..."></textarea>
<input type="text" id="customId" placeholder="Custom ID (optional - leave empty for random)">
<div class="hint">üí° Custom ID erlaubt: a-z, A-Z, 0-9, _, -</div>
<div class="btn-group">
<button id="uploadBtn" onclick="upload()">üì§ Upload</button>
<button class="clear" onclick="clearForm()">üóëÔ∏è Clear</button>
</div>
</div>
<div class="list" id="list"></div>
</div>

<div class="modal" id="editModal">
<div class="modal-content">
<h2>Edit Script</h2>
<input type="text" id="editName" placeholder="Script Name">
<textarea id="editCode" placeholder="Script Code" style="min-height:300px"></textarea>
<div class="modal-buttons">
<button onclick="saveEdit()">üíæ Save</button>
<button class="clear" onclick="closeEdit()">‚úñÔ∏è Cancel</button>
</div>
</div>
</div>

<div class="modal confirm-modal" id="confirmModal">
<div class="modal-content">
<h2>‚ùå Delete Script</h2>
<p>Willst du dieses Script wirklich l√∂schen?</p>
<div class="modal-buttons">
<button class="clear" id="deleteBtn" onclick="confirmDelete()">üóëÔ∏è L√∂schen</button>
<button onclick="closeConfirm()">‚úñÔ∏è Abbrechen</button>
</div>
</div>
</div>

<script>
let editingId=null
let deleteId=null
let codeCache={}
let isLoading=false
let sessionStart=Date.now()
let sessionDuration=180000

function updateTimer(){
const elapsed=Date.now()-sessionStart
const remaining=Math.max(0,sessionDuration-elapsed)
const minutes=Math.floor(remaining/60000)
const seconds=Math.floor((remaining%60000)/1000)
document.getElementById('timer').textContent=minutes+':'+(seconds<10?'0':'')+seconds
if(remaining<=0){
location.reload()
}
}

setInterval(updateTimer,1000)

async function checkSession(){
try{
const res=await fetch('/api/list?t='+Date.now(),{cache:'no-store'})
if(res.status===401){
location.reload()
}
}catch(e){
location.reload()
}
}

setInterval(checkSession,30000)

async function upload(){
if(isLoading)return
const name=document.getElementById('name').value.trim()
const code=document.getElementById('code').value.trim()
const customId=document.getElementById('customId').value.trim()
if(!name||!code)return
isLoading=true
document.getElementById('uploadBtn').disabled=true
document.getElementById('uploadBtn').textContent='‚è≥ Uploading...'
try{
const res=await fetch('/api/upload',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name,code,customId})})
if(res.status===401){location.reload();return}
const data=await res.json()
if(data.error){alert('‚ùå Error: '+data.error);return}
document.getElementById('name').value=''
document.getElementById('code').value=''
document.getElementById('customId').value=''
await waitForKV(data.id,true)
}catch(e){
alert('‚ùå Upload failed: '+e.message)
}finally{
isLoading=false
document.getElementById('uploadBtn').disabled=false
document.getElementById('uploadBtn').textContent='üì§ Upload'
}
}

function clearForm(){
document.getElementById('name').value=''
document.getElementById('code').value=''
document.getElementById('customId').value=''
}

function toggleMenu(id,event){
event.stopPropagation()
const dropdown=document.getElementById('menu-'+id)
const allDropdowns=document.querySelectorAll('.dropdown')
allDropdowns.forEach(d=>{
if(d.id!=='menu-'+id)d.classList.remove('show')
})
dropdown.classList.toggle('show')
}

async function openEdit(id,event){
event.stopPropagation()
try{
let code=codeCache[id]
if(!code){
const res=await fetch('/api/get/'+id,{cache:'no-store'})
if(res.status===401){location.reload();return}
const data=await res.json()
if(data.error){alert('‚ùå Error: '+data.error);return}
code=data.code
codeCache[id]=code
}
editingId=id
const items=await fetchList()
const item=items.find(i=>i.id===id)
document.getElementById('editName').value=item?.name||'Unnamed'
document.getElementById('editCode').value=code||''
document.getElementById('editModal').classList.add('show')
closeAllDropdowns()
}catch(e){
alert('‚ùå Failed to load script: '+e.message)
}
}

function closeEdit(){
document.getElementById('editModal').classList.remove('show')
editingId=null
}

async function saveEdit(){
const name=document.getElementById('editName').value.trim()
const code=document.getElementById('editCode').value.trim()
if(!name||!code)return
try{
const res=await fetch('/api/edit',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id:editingId,name,code})})
if(res.status===401){location.reload();return}
const data=await res.json()
if(data.error){alert('‚ùå Error: '+data.error);return}
codeCache[editingId]=code
closeEdit()
await waitForKV(editingId,true)
}catch(e){
alert('‚ùå Edit failed: '+e.message)
}
}

function openDeleteConfirm(id,event){
event.stopPropagation()
deleteId=id
document.getElementById('confirmModal').classList.add('show')
closeAllDropdowns()
}

function closeConfirm(){
document.getElementById('confirmModal').classList.remove('show')
deleteId=null
}

async function confirmDelete(){
if(isLoading)return
isLoading=true
document.getElementById('deleteBtn').disabled=true
document.getElementById('deleteBtn').textContent='‚è≥ L√∂schen...'
try{
const res=await fetch('/api/delete',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id:deleteId})})
if(res.status===401){location.reload();return}
const data=await res.json()
if(data.error){alert('‚ùå Error: '+data.error);return}
delete codeCache[deleteId]
closeConfirm()
await waitForKV(deleteId,false)
}catch(e){
alert('‚ùå Delete failed: '+e.message)
}finally{
isLoading=false
document.getElementById('deleteBtn').disabled=false
document.getElementById('deleteBtn').textContent='üóëÔ∏è L√∂schen'
}
}

function copyLoadstring(id,event){
event.preventDefault()
const loadstr=`loadstring(game:HttpGet("${location.origin}/raw/${id}"))()`
navigator.clipboard.writeText(loadstr)
}

function closeAllDropdowns(){
document.querySelectorAll('.dropdown').forEach(d=>d.classList.remove('show'))
}

async function fetchList(){
const res=await fetch('/api/list?t='+Date.now(),{cache:'no-store',headers:{'Cache-Control':'no-cache','Pragma':'no-cache'}})
if(res.status===401){location.reload();return[]}
return await res.json()
}

async function waitForKV(id,shouldExist){
const maxAttempts=15
const delay=1000
document.getElementById('list').innerHTML='<div class="loading"><span class="spinner"></span>Updating...</div>'
for(let i=0;i<maxAttempts;i++){
await new Promise(r=>setTimeout(r,delay))
try{
const items=await fetchList()
const exists=items.some(item=>item.id===id)
if(shouldExist&&exists){await loadList();return}
if(!shouldExist&&!exists){await loadList();return}
}catch(e){}
}
await loadList()
}

async function loadList(){
try{
const items=await fetchList()
if(!Array.isArray(items)||items.length===0){
document.getElementById('list').innerHTML='<div style="text-align:center;color:#666;padding:40px">Keine Scripts vorhanden</div>'
return
}
items.sort((a,b)=>b.date-a.date)
document.getElementById('list').innerHTML=items.map(s=>`
<div class="item">
<div class="item-header">
<h3>${escapeHtml(s.name)}</h3>
<button class="menu-btn" onclick="toggleMenu('${s.id}',event)">‚ãÆ</button>
<div class="dropdown" id="menu-${s.id}">
<button onclick="openEdit('${s.id}',event)">‚úèÔ∏è Edit</button>
<button class="delete" onclick="openDeleteConfirm('${s.id}',event)">üóëÔ∏è Delete</button>
</div>
</div>
<div class="date">üìÖ ${new Date(s.date).toLocaleString('de-DE')} ‚Ä¢ ID: ${escapeHtml(s.id)}</div>
<div class="links">
<a href="/raw/${s.id}?pw=Luna-132" target="_blank">üëÅÔ∏è View Raw</a>
<a onclick="copyLoadstring('${s.id}',event)">üìã Copy Loadstring</a>
</div>
</div>
`).join('')
}catch(e){
document.getElementById('list').innerHTML='<div style="text-align:center;color:#ff3333;padding:40px">‚ùå Fehler beim Laden</div>'
}
}

function escapeHtml(text){
const div=document.createElement('div')
div.textContent=text
return div.innerHTML
}

document.addEventListener('click',()=>closeAllDropdowns())

loadList()
setInterval(loadList,15000)
</script>
</body>
</html>
