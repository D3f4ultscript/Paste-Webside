function loginHtml(){
return `<!DOCTYPE html>
<html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0"><title>Login</title><style>*{margin:0;padding:0;box-sizing:border-box}body{font-family:monospace;background:#000;color:#fff;display:flex;align-items:center;justify-content:center;height:100vh}.box{width:min(420px,90vw);background:#111;border:1px solid #333;padding:28px;border-radius:10px}h1{font-size:18px;margin-bottom:8px}p{color:#999;font-size:13px;margin-bottom:16px}input{width:100%;padding:12px;background:#000;border:1px solid #333;color:#fff;font-family:monospace;border-radius:8px}button{margin-top:12px;width:100%;padding:12px;border:0;background:#0066ff;color:#fff;font-weight:700;cursor:pointer;border-radius:8px}button:hover{background:#0052cc}.err{display:none;color:#ff6666;font-size:12px;margin-top:10px}</style></head><body><div class="box"><h1>Access required</h1><p>Enter password</p><input id="pw" type="password" placeholder="Password" autocomplete="off" autofocus onkeypress="if(event.key==='Enter')go()"><button onclick="go()">Unlock</button><div class="err" id="err">Wrong password</div></div><script>async function go(){var pw=document.getElementById('pw').value;if(!pw)return;var res=await fetch('/app',{headers:{'X-Password':pw}});if(res.status!==200){document.getElementById('err').style.display='block';return}var html=await res.text();html=html.replace('__PW__',JSON.stringify(pw));document.open();document.write(html);document.close()}</script></body></html>`
}

function appHtml(token){
return `<!DOCTYPE html>
<html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0"><title>Script Paste</title><style>*{margin:0;padding:0;box-sizing:border-box}body{font-family:monospace;background:#000;color:#fff;padding:20px;min-height:100vh}h1{font-size:24px;margin-bottom:20px;text-align:center}.token{background:#111;border:1px solid #333;padding:12px;margin-bottom:20px;border-radius:8px;font-size:12px;word-break:break-all}.panel{background:#111;border:1px solid #333;padding:20px;margin-bottom:20px;border-radius:8px}input,textarea{width:100%;padding:10px;margin:8px 0;background:#000;border:1px solid #333;color:#fff;font-family:monospace;border-radius:6px}textarea{min-height:180px;resize:vertical}.row{display:flex;gap:8px}.btn{padding:10px;background:#0066ff;color:#fff;border:none;cursor:pointer;border-radius:6px;font-weight:700;flex:1}.btn:hover{background:#0052cc}.btn:disabled{opacity:0.5;cursor:not-allowed}.btn.gray{background:#333}.list{margin-top:20px}.item{background:#111;border:1px solid #333;padding:16px;margin:10px 0;border-radius:8px;position:relative}.item h3{font-size:15px;margin-bottom:6px}.small{font-size:11px;color:#999;margin-top:4px}.links{margin-top:8px;display:flex;gap:10px}.links a{font-size:12px;color:#4aa3ff;text-decoration:none;cursor:pointer}.links a:hover{color:#7fd5ff}.menu-btn{position:absolute;top:16px;right:16px;background:#222;border:1px solid #333;color:#bbb;padding:4px 8px;cursor:pointer;border-radius:6px}.dropdown{display:none;position:absolute;right:16px;top:42px;background:#222;border:1px solid #333;border-radius:6px;overflow:hidden;z-index:100;min-width:120px}.dropdown.show{display:block}.dropdown button{width:100%;text-align:left;background:none;border:none;color:#fff;padding:10px;cursor:pointer;font-size:12px}.dropdown button:hover{background:#0066ff}.dropdown button.delete{color:#ff6666}.dropdown button.delete:hover{background:#ff3333;color:#fff}.loading{padding:16px;text-align:center;color:#999}</style></head><body><h1>Script Paste</h1><div class="token"><strong>RAW Token (for Loadstring):</strong> ${token}</div><div class="panel"><input type="text" id="name" placeholder="Script Name"><textarea id="code" placeholder="Paste script here..."></textarea><input type="text" id="customId" placeholder="Custom ID (optional)"><div class="row"><button class="btn" id="uploadBtn" onclick="upload()">Upload</button><button class="btn gray" onclick="clearForm()">Clear</button></div></div><div class="list" id="list"></div><script>var PW=__PW__;var TOKEN='${token}';var editingId=null;function esc(s){var d=document.createElement('div');d.textContent=s==null?'':String(s);return d.innerHTML}function closeDropdowns(){document.querySelectorAll('.dropdown').forEach(function(d){d.classList.remove('show')})}document.addEventListener('click',function(){closeDropdowns()});function clearForm(){document.getElementById('name').value='';document.getElementById('code').value='';document.getElementById('customId').value=''}function toggleMenu(id,e){e.stopPropagation();var dd=document.getElementById('menu-'+id);document.querySelectorAll('.dropdown').forEach(function(x){if(x!==dd)x.classList.remove('show')});dd.classList.toggle('show')}async function fetchList(){var res=await fetch('/api/list',{headers:{'X-Password':PW}});if(res.status!==200)throw new Error('fail');return await res.json()}function renderList(items){if(!items||items.length===0){document.getElementById('list').innerHTML='<div class="loading">No scripts</div>';return}var out=[];for(var i=0;i<items.length;i++){var s=items[i];var id=esc(s.id);var name=esc(s.name);var dateStr=new Date(s.date||0).toLocaleString('de-DE');out.push('<div class="item"><button class="menu-btn" onclick="toggleMenu(\\''+id+'\\',event)">⋮</button><div class="dropdown" id="menu-'+id+'"><button onclick="openEdit(\\''+id+'\\')">Edit</button><button class="delete" onclick="openDelete(\\''+id+'\\')">Delete</button></div><h3>'+name+'</h3><div class="small">'+dateStr+' • ID: '+id+'</div><div class="links"><a onclick="copyLoadstring(\\''+id+'\\',event)">Copy Loadstring</a></div></div>')}document.getElementById('list').innerHTML=out.join('')}async function loadList(){try{document.getElementById('list').innerHTML='<div class="loading">Loading...</div>';var items=await fetchList();renderList(items)}catch(e){document.getElementById('list').innerHTML='<div class="loading" style="color:#ff6666">Error</div>'}}async function upload(){var name=document.getElementById('name').value.trim();var code=document.getElementById('code').value.trim();var customId=document.getElementById('customId').value.trim();if(!name||!code)return;try{document.getElementById('uploadBtn').disabled=true;var res=await fetch('/api/upload',{method:'POST',headers:{'Content-Type':'application/json','X-Password':PW},body:JSON.stringify({name:name,code:code,customId:customId})});var data=await res.json();if(res.status!==200){alert(data.error||'Upload failed');return}clearForm();await new Promise(r=>setTimeout(r,2000));await loadList()}finally{document.getElementById('uploadBtn').disabled=false}}async function openEdit(id){alert('Edit coming soon')}async function openDelete(id){if(!confirm('Delete this script?'))return;try{var res=await fetch('/api/delete',{method:'POST',headers:{'Content-Type':'application/json','X-Password':PW},body:JSON.stringify({id:id})});if(res.status!==200){alert('Delete failed');return}await new Promise(r=>setTimeout(r,2000));await loadList()}catch(e){}}function copyLoadstring(id,e){e.preventDefault();var url=location.origin+'/raw/'+id+'?token='+TOKEN;navigator.clipboard.writeText('loadstring(game:HttpGet(\"'+url+'\"))()')}loadList()</script></body></html>`
}

export async function onRequestGet(context){
const pass=(context.env.SITE_PASSWORD||'').trim()
const token=(context.env.RAW_TOKEN||'').trim()
const provided=(context.request.headers.get('X-Password')||'').trim()
if(!pass||!token) return new Response('Server not configured',{status:500})
if(provided!==pass) return new Response(loginHtml(),{status:401,headers:{'Content-Type':'text/html'}})
return new Response(appHtml(token),{status:200,headers:{'Content-Type':'text/html'}})
}
